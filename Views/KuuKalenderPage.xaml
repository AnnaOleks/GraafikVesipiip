<?xml version="1.0" encoding="utf-8" ?>
<!-- Страница календаря: корректные xmlns, корректный x:Class, один корневой контейнер -->
<ContentPage
    x:Name="ThisPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:conv="clr-namespace:GraafikVesipiip.Converters"
    x:Class="GraafikVesipiip.Views.KuuKalenderPage"
    Shell.NavBarIsVisible="False"
    NavigationPage.HasNavigationBar="False"
    Title="Kalender">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Конвертер окраски «текущий месяц / не текущий» -->
            <conv:BoolToColorConverter x:Key="BoolToColor" />
            <conv:IntGreaterThanZeroConverter x:Key="IntGtZero" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <Image 
        Source="hookah.png"
        Aspect="AspectFill"
        Opacity="0.15" />
        <VerticalStackLayout 
            Padding="16" 
            Spacing="12">
            <Label 
                Text="Календарь" 
                FontSize="32"
                FontAttributes="Bold"
                HorizontalTextAlignment="Center"
                Margin="0,20,0,0"/>

            <!-- Переключение месяцев -->
            <Grid 
                ColumnDefinitions="Auto,*,Auto" 
                Margin="0,30,0,30">
                <Button 
                    Grid.Column="0" 
                    Text="◀" 
                    Command="{Binding EelmineKuuCommand}">
                    <Button.Shadow
                        InputTransparent="True"  
                        ZIndex="-1">
                        <Shadow
                            Radius="5"/>
                    </Button.Shadow>
                </Button>
                <Label  
                    Grid.Column="1"
                    Text="{Binding PraeguneKuu, StringFormat='{}{0:MMMM yyyy}'}"
                    FontSize="23"
                    HorizontalTextAlignment="Center" />
                <Button 
                    Grid.Column="2" 
                    Text="▶" 
                    Command="{Binding JargmineKuuCommand}" >
                    <Button.Shadow
                        InputTransparent="True"  
                        ZIndex="-1">
                        <Shadow
                            Radius="5"/>
                    </Button.Shadow>
                </Button>
            </Grid>

            <!-- Заголовок дней недели -->
            <Grid ColumnDefinitions="*,*,*,*,*,*,*">
                <Label 
                    Grid.Column="0" 
                    Text="E" 
                    HorizontalTextAlignment="Center"/>
                <Label 
                    Grid.Column="1" 
                    Text="T" 
                    HorizontalTextAlignment="Center"/>
                <Label 
                    Grid.Column="2" 
                    Text="K" 
                    HorizontalTextAlignment="Center"/>
                <Label 
                    Grid.Column="3" 
                    Text="N" 
                    HorizontalTextAlignment="Center"/>
                <Label 
                    Grid.Column="4" 
                    Text="R" 
                    HorizontalTextAlignment="Center"/>
                <Label 
                    Grid.Column="5" 
                    Text="L" 
                    HorizontalTextAlignment="Center"/>
                <Label 
                    Grid.Column="6" 
                    Text="P" 
                    HorizontalTextAlignment="Center"/>
            </Grid>

            <!-- Календарная сетка 6×7 -->
            <CollectionView 
                ItemsSource="{Binding Paevad}"
                Margin="0,0,0,0"
                SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout 
                        Orientation="Vertical" 
                        Span="7" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <!-- Ячейка дня -->
                        <Border 
                            StrokeShape="RoundRectangle 10"
                            Padding="10"
                            Margin="1"
                            BackgroundColor="{Binding OnPraeguneKuu, Converter={StaticResource BoolToColor}, ConverterParameter='#af9d98|#d4d4d3'}">
                            <Grid 
                                RowDefinitions="*,Auto">
                               
                                <!-- САМО ЧИСЛО ДНЯ -->
                                <Label 
                                    Grid.Row="0"
                                    Text="{Binding Kuupaev, StringFormat='{}{0:dd}'}"
                                    HorizontalOptions="Center"
                                    VerticalOptions="Center"
                                    FontAttributes="Bold"
                                    TextColor="White"/>    

                                 <!-- НИЖНЯЯ ПОЛОСА С МЕТКАМИ -->
                                 <VerticalStackLayout 
                                    Grid.Row="1"
                                    Spacing="3"
                                    Padding="0,2,0,0"
                                     
                                    BindableLayout.ItemsSource="{Binding Markers}">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate>
                                            <!-- Горизонтальная полоска -->
                                            <BoxView 
                                                HeightRequest="2"
                                                HorizontalOptions="Fill"
                                                CornerRadius="2"
                                                Color="{Binding .}" 
                                                BackgroundColor="Transparent"/>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>

                                </VerticalStackLayout>

                                <!-- если меток больше 4 — покажем +N -->
                                <Label 
                                    Grid.Row="1"
                                    Text="{Binding MarkerOverflow, StringFormat='+{0}'}"
                                    IsVisible="{Binding MarkerOverflow, Converter={StaticResource IntGtZero}}"
                                    FontSize="10"
                                    HorizontalOptions="End"
                                    VerticalOptions="End"
                                    Margin="0,3,0,0" />    
                            
                                <!-- Кликабельность ячейки -->
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer
                                          Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.AvaPaevCommand}"
                                          CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>
                            </Grid>
                        </Border>
                    </DataTemplate>

                </CollectionView.ItemTemplate>
            </CollectionView>
            <VerticalStackLayout>
                <Button
                    Text="Назад"
                    Command="{Binding TagasiEsileheleCommand}"
                    Margin="0,30,0,0">
                    <Button.Shadow>
                        <Shadow
                                Radius="5"/>
                    </Button.Shadow>
                </Button>
            </VerticalStackLayout>
        </VerticalStackLayout>
    </Grid>
</ContentPage>
